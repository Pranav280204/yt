<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Stats Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.min.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #f8f9fa, #e9ecef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin-top: 50px;
      padding: 30px;
      background-color: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .song-section {
      margin-bottom: 60px;
      border-top: 2px solid #dee2e6;
      padding-top: 35px;
    }
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      background-color: #f8f9fa;
    }
    .error-message { color: #dc3545; font-weight: bold; }
    .success-message { color: #28a745; font-weight: bold; }
    .form-section {
      background-color: #f1f3f5;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 40px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .video-actions { display: flex; gap: 15px; }
    .video-thumbnail {
      border-radius: 15px;
      margin-top: 15px;
      max-width: 250px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .video-thumbnail:hover { transform: scale(1.05); }
    .accordion-button {
      font-weight: bold;
      background-color: #e9ecef;
      color: #333;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .table th, .table td {
      vertical-align: middle;
      text-align: center;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background-color: #343a40;
      color: #fff;
      z-index: 2;
    }
    .chart-container {
      position: relative;
      height: 320px;
      width: 100%;
    }
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .video-actions { flex-direction: column; gap: 10px; }
      .video-thumbnail { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">YouTube Stats Tracker</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <p class="text-center fw-bold {{ 'error-message' if category == 'error' else 'success-message' }}">{{ message }}</p>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Add Video Form -->
    <div class="form-section">
      <h4 class="mb-3">Add a YouTube Video</h4>
      <form method="POST" action="/add_video" id="add-video-form">
        <div class="mb-3">
          <label for="video_link" class="form-label">YouTube Video Link:</label>
          <input type="url" class="form-control" id="video_link" name="video_link"
                 placeholder="https://www.youtube.com/watch?v=..." required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Add & Start Tracking</button>
      </form>
    </div>

    <!-- Videos List -->
    {% for video in videos %}
      <div class="song-section">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <div class="d-flex align-items-center">
            <img src="https://img.youtube.com/vi/{{ video.video_id }}/0.jpg"
                 class="video-thumbnail me-3" alt="Thumbnail" loading="lazy">
            <h3 class="mb-0">
              {{ video.name }}
              {% if not video.is_tracking %}
                <span class="text-muted fs-5">(Paused)</span>
              {% endif %}
            </h3>
          </div>
          <div class="video-actions mt-3 mt-md-0">
            <a href="/export/{{ video.video_id }}" class="btn btn-outline-success btn-sm">Export</a>
            <a href="/toggle_tracking/{{ video.video_id }}" class="btn btn-outline-warning btn-sm">
              {% if video.is_tracking %}Pause{% else %}Resume{% endif %}
            </a>
            <a href="/remove_video/{{ video.video_id }}" class="btn btn-outline-danger btn-sm"
               onclick="return confirm('Delete this video and all data?')">Delete</a>
          </div>
        </div>

        <!-- Daily Data Accordion -->
        <div class="accordion mt-4" id="accordion_{{ video.video_id }}">
          {% for date, data in video.daily_data.items() %}
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                        type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse_{{ video.video_id }}_{{ loop.index0 }}">
                  {{ date }}
                  <span class="ms-3 text-muted small">({{ data|length }} records)</span>
                </button>
              </h2>
              <div id="collapse_{{ video.video_id }}_{{ loop.index0 }}"
                   class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                   data-bs-parent="#accordion_{{ video.video_id }}">
                <div class="accordion-body">

                  <!-- Table: 5 COLUMNS (Added Likes) -->
                  <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered mb-4">
                      <thead class="table-dark">
                        <tr>
                          <th>Time (IST)</th>
                          <th>Views</th>
                          <th>Likes</th>
                          <th>View Gain</th>
                          <th>Hourly Gain</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in data %}
                          <tr>
                            <td><code>{{ item[0].split(" ")[1] }}</code></td>
                            <td><strong>{{ "{:,}".format(item[1]) }}</strong></td>
                            <td>{{ "{:,}".format(item[4] if item|length > 4 else 0) }}</td>
                            <td style="color: {% if item[2] > 0 %}#198754{% elif item[2] < 0 %}#dc3545{% else %}gray{% endif %}; font-weight: bold;">
                              {{ "+" if item[2] > 0 else "" }}{{ "{:,}".format(item[2]) }}
                            </td>
                            <td style="color: {% if item[3] > 0 %}#198754{% elif item[3] < 0 %}#dc3545{% else %}gray{% endif %}; font-weight: bold;">
                              {{ "+" if item[3] > 0 else "" }}{{ "{:,}".format(item[3]) }}/hr
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                  <!-- Chart -->
                  {% if data %}
                    <div class="chart-container">
                      <canvas id="chart_{{ video.video_id }}_{{ loop.index0 }}"></canvas>
                    </div>
                    <script>
                      document.addEventListener("DOMContentLoaded", function() {
                        const ctx = document.getElementById('chart_{{ video.video_id }}_{{ loop.index0 }}');
                        new Chart(ctx, {
                          type: 'line',
                          data: {
                            labels: {{ data|map(attribute=0)|list|tojson }},
                            datasets: [
                              {
                                label: 'Total Views',
                                data: {{ data|map(attribute=1)|list|tojson }},
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                              },
                              {
                                label: 'View Gain',
                                data: {{ data|map(attribute=2)|list|tojson }},
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y1'
                              },
                              {
                                label: 'Hourly Gain',
                                data: {{ data|map(attribute=3)|list|tojson }},
                                borderColor: '#fd7e14',
                                backgroundColor: 'rgba(253, 126, 20, 0.2)',
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y1'
                              }
                            ]
                          },
                          options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                              legend: { position: 'top' },
                              title: {
                                display: true,
                                text: '{{ video.name }} - {{ date }}'
                              }
                            },
                            scales: {
                              x: { title: { display: true, text: 'Time (IST)' } },
                              y: {
                                position: 'left',
                                title: { display: true, text: 'Total Views' }
                              },
                              y1: {
                                position: 'right',
                                title: { display: true, text: 'Gains' },
                                grid: { drawOnChartArea: false }
                              }
                            }
                          }
                        });
                      });
                    </script>
                  {% endif %}

                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="text-center text-muted">No videos added yet. Paste a YouTube link above to start tracking!</p>
    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>